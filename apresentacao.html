<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados - Testes de Performance K6</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }
        body.dark-theme {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
        }
        body.dark-theme .container {
            background: #1e293b;
        }
        body.dark-theme .kpi-card {
            background: linear-gradient(180deg, #334155, #1e293b);
        }
        body.dark-theme .kpi-label {
            color: #94a3b8;
        }
        body.dark-theme .kpi-value {
            color: #e2e8f0;
        }
        body.dark-theme .chart-container {
            background: #334155;
        }
        body.dark-theme h3 {
            color: #e2e8f0 !important;
        }
        body.dark-theme th {
            background: #475569;
        }
        body.dark-theme td {
            background: #334155;
            color: #e2e8f0;
        }
        body.dark-theme tr:hover td {
            background: #475569;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(90deg, #0f172a 0%, #0b3a67 100%);
            color: #fff;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        .header h1 {
            font-size: 1.4em;
            margin: 0;
        }
        .header .meta {
            text-align: right;
            font-size: 0.9em;
            opacity: 0.9;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 20px;
        }
        .sidebar {
            background: #0b1220;
            color: #e6eef8;
            padding: 20px;
            border-radius: 8px;
            height: fit-content;
        }
        .main {
            padding: 20px 30px;
        }
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 18px;
        }
        .kpi-card {
            background: linear-gradient(180deg,#ffffff,#fbfdff);
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(13,47,82,0.06);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .kpi-label { font-size: 0.8em; color: #6b7280; text-transform: uppercase; }
        .kpi-value { font-size: 1.6em; font-weight: 700; color: #0f172a; }
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        .summary-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        .summary-card .label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .content {
            padding: 0;
        }
        .section {
            margin-bottom: 22px;
            padding: 12px 0;
        }
        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8em;
        }
        .test-section h3 {
            color: #764ba2;
            margin: 15px 0 10px 0;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 3px solid #667eea;
        }
        .metric-box .metric-label {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metric-box .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 10px;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .chart-container {
            padding: 14px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(13,47,82,0.06);
        }
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-bottom: 18px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .conclusion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            margin-top: 40px;
            border-radius: 15px;
        }
        .conclusion h2 {
            margin-bottom: 20px;
        }
        .conclusion ul {
            list-style: none;
            padding-left: 0;
        }
        .conclusion li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
        }
        .conclusion li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            font-weight: bold;
            font-size: 1.2em;
        }
        .footer {
            text-align: center;
            padding: 16px;
            background: #f1f5f9;
            color: #475569;
            font-size: 0.85em;
            border-top: 1px solid #e6eef8;
        }

        @media (max-width: 1000px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .kpi-row { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Resultados dos Testes de Performance</h1>
            <p>AvaliaÃ§Ã£o completa da API usando k6</p>
            <p style="font-size: 0.9em; margin-top: 10px;">19 de novembro de 2025</p>
        </div>

        <div class="dashboard-grid">
            <aside class="sidebar">
                <h3>Filtros</h3>
                <p style="color:#b7c3d6; font-size:0.95em;">Selecione os testes que deseja visualizar:</p>
                <div style="margin-top:12px;">
                    <label><input type="checkbox" class="filter-test" value="smoke" checked> Smoke</label><br>
                    <label><input type="checkbox" class="filter-test" value="load" checked> Load</label><br>
                    <label><input type="checkbox" class="filter-test" value="stress" checked> Stress</label><br>
                    <label><input type="checkbox" class="filter-test" value="spike" checked> Spike</label><br>
                    <label><input type="checkbox" class="filter-test" value="soak" checked> Soak</label>
                </div>

                <hr style="border-color:#0f2136; margin:16px 0;">
                <h4>Status</h4>
                <p id="status-summary" style="color:#b7c3d6; font-size:0.95em;">Carregando resultados...</p>
                <hr style="border-color:#0f2136; margin:16px 0;">
                <h4>AÃ§Ãµes</h4>
                <button id="btn-theme" style="width:100%; padding:8px; margin-bottom:8px; border:none; border-radius:4px; background:#3b82f6; color:#fff; cursor:pointer;">ðŸŒ™ Tema Escuro</button>
                <button id="btn-export" style="width:100%; padding:8px; border:none; border-radius:4px; background:#10b981; color:#fff; cursor:pointer;">ðŸ“¥ Export CSV</button>
                <hr style="border-color:#0f2136; margin:16px 0;">
                <p style="color:#9fb0c8; font-size:0.85em;">ðŸ’¡ Sirva com: <code>python -m http.server</code></p>
            </aside>

            <main class="main">
                <div class="kpi-row">
                    <div class="kpi-card">
                        <div class="kpi-label">Total de Testes</div>
                        <div id="kpi-tests" class="kpi-value">â€”</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">RequisiÃ§Ãµes Total</div>
                        <div id="kpi-requests" class="kpi-value">â€”</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Taxa de Sucesso</div>
                        <div id="kpi-success" class="kpi-value">â€”</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">LatÃªncia MÃ©dia (ms)</div>
                        <div id="kpi-latency" class="kpi-value">â€”</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 style="margin:6px 0 10px 0; color:#0f172a;">LatÃªncia â€” MÃ©dia e p(95)</h3>
                        <canvas id="latencyChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="margin:6px 0 10px 0; color:#0f172a;">Status Geral</h3>
                        <canvas id="statusChart" style="max-height:220px;"></canvas>
                    </div>
                </div>

                <div class="chart-container" style="margin-bottom:16px;">
                    <h3 style="margin:6px 0 10px 0; color:#0f172a;">Volume de RequisiÃ§Ãµes</h3>
                    <canvas id="volumeChart"></canvas>
                </div>

                <h3 style="color:#0f172a; margin: 8px 0;">Tabela Comparativa</h3>
                <div class="chart-container">
                    <table id="compare-table">
                        <thead>
                            <tr>
                                <th>Teste</th>
                                <th>LatÃªncia MÃ©dia (ms)</th>
                                <th>LatÃªncia p(95) (ms)</th>
                                <th>Taxa de Falha</th>
                                <th>Total RequisiÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="conclusion">
                    <h2>ðŸŽ¯ ConclusÃµes RÃ¡pidas</h2>
                    <ul>
                        <li id="concl-1">Carregando conclusÃµes...</li>
                    </ul>
                </div>
            </main>
        </div>

        <div class="footer">
            <p><strong>API Testada:</strong> GET /sum?a=1&b=2 â€” Painel Ãºnico com todos os resultados</p>
        </div>
    </div>

    <script>
        // Arquivos esperados (se existir em workspace)
        const tests = ['smoke','load','stress','spike','soak'];
        const fileFor = {
            smoke: 'saida_smoke.json',
            load: 'saida_load.json',
            stress: 'saida_stress.json',
            spike: 'saida_spike.json',
            soak: 'saida_soak.json'
        };

        // Valores defaults (usados se nÃ£o encontrar JSONs)
        const defaults = {
            smoke: {avg:1.93, p95:4.82, fail:0, reqs:100},
            load:  {avg:1.04, p95:1.95, fail:0, reqs:2853},
            stress:{avg:1.04, p95:2.08, fail:0, reqs:11450},
            spike: {avg:0.81, p95:1.48, fail:0, reqs:3222},
            soak:  {avg:1.94, p95:4.69, fail:0, reqs:3600}
        };

        // Extrai mÃ©tricas do formato k6 JSON (metrics.http_req_duration, metrics.http_reqs)
        function extractMetrics(json, key) {
            if (!json) return null;
            
            // Formato k6: json.metrics.http_req_duration com avg, p(95), etc.
            if (json.metrics && json.metrics.http_req_duration) {
                const dur = json.metrics.http_req_duration;
                const reqs = json.metrics.http_reqs && json.metrics.http_reqs.count ? json.metrics.http_reqs.count : 0;
                const avg = dur.avg || 0;
                const p95 = dur['p(95)'] || 0;
                
                // Taxa de falha (http_req_failed)
                const failed = json.metrics.http_req_failed;
                const failRate = failed && failed.rate !== undefined ? failed.rate * 100 : 0;
                
                return {
                    avg: Number(avg),
                    p95: Number(p95),
                    fail: Number(failRate),
                    reqs: Number(reqs)
                };
            }
            
            // Fallback para formato custom simples
            if (json.avg !== undefined && json.p95 !== undefined) {
                return {avg: json.avg, p95: json.p95, fail: json.fail||0, reqs: json.reqs||0};
            }
            
            return null;
        }

        async function loadAll() {
            const results = {};
            const loadPromises = tests.map(t => {
                const file = fileFor[t];
                return fetch(file).then(r => r.json()).then(j=>({t:t, j:j})).catch(()=>({t:t, j:null}));
            });

            const settled = await Promise.all(loadPromises);
            settled.forEach(item => {
                const t = item.t;
                const j = item.j;
                const m = extractMetrics(j, t) || defaults[t];
                results[t] = m;
            });
            return results;
        }

        // GrÃ¡ficos (instÃ¢ncias)
        let latencyChart, volumeChart, statusChart;

        function createCharts(labels, latencyAvg, latencyP95, volume, statusCounts) {
            const ctxL = document.getElementById('latencyChart').getContext('2d');
            if (latencyChart) latencyChart.destroy();
            latencyChart = new Chart(ctxL, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'LatÃªncia MÃ©dia (ms)', data: latencyAvg, backgroundColor: '#3b82f6' },
                        { label: 'p(95) (ms)', data: latencyP95, backgroundColor: '#6366f1' }
                    ]
                },
                options: { responsive:true, scales:{ y: { beginAtZero:true } } }
            });

            const ctxV = document.getElementById('volumeChart').getContext('2d');
            if (volumeChart) volumeChart.destroy();
            volumeChart = new Chart(ctxV, {
                type: 'line',
                data: { labels, datasets:[{ label:'RequisiÃ§Ãµes', data: volume, borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,0.08)', fill:true }] },
                options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
            });

            const ctxS = document.getElementById('statusChart').getContext('2d');
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(ctxS, {
                type: 'doughnut',
                data: { labels: ['Sucesso','Falhas'], datasets:[{ data: statusCounts, backgroundColor:['#10b981','#ef4444'] }] },
                options:{ responsive:true }
            });
        }

        function renderTable(results, selected) {
            const tbody = document.querySelector('#compare-table tbody');
            tbody.innerHTML = '';
            selected.forEach(k => {
                const r = results[k];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${k.charAt(0).toUpperCase()+k.slice(1)}</strong></td>
                    <td>${(r.avg||0).toFixed(2)} ms</td>
                    <td>${(r.p95||0).toFixed(2)} ms</td>
                    <td>${(r.fail||0).toFixed(2)}%</td>
                    <td>${(r.reqs||0).toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateKPIs(results, selected) {
            const keys = selected;
            const totalTests = keys.length;
            const totalReqs = keys.reduce((s,k)=>s + (results[k].reqs||0),0);
            const avgLatency = keys.reduce((s,k)=>s + (results[k].avg||0),0) / Math.max(1, totalTests);
            const totalFailRate = keys.reduce((s,k)=>s + (results[k].fail||0),0) / Math.max(1, totalTests);

            document.getElementById('kpi-tests').innerText = totalTests;
            document.getElementById('kpi-requests').innerText = totalReqs.toLocaleString();
            document.getElementById('kpi-success').innerText = `${(100 - totalFailRate).toFixed(2)}%`;
            document.getElementById('kpi-latency').innerText = avgLatency.toFixed(2);
            document.getElementById('status-summary').innerText = `Testes: ${totalTests} â€¢ RequisiÃ§Ãµes: ${totalReqs.toLocaleString()} â€¢ Falha mÃ©dia: ${totalFailRate.toFixed(2)}%`;
        }

        function gatherForCharts(results, selected) {
            const labels = [];
            const avg = [];
            const p95 = [];
            const reqs = [];
            let success = 0, fail = 0;
            selected.forEach(k => {
                labels.push(k.charAt(0).toUpperCase()+k.slice(1));
                const r = results[k];
                avg.push(r.avg||0);
                p95.push(r.p95||0);
                reqs.push(r.reqs||0);
                const f = r.fail||0;
                fail += f;
                success += (100 - f);
            });
            return {labels, avg, p95, reqs, statusCounts:[success, fail]};
        }

        function getSelectedTests() {
            return Array.from(document.querySelectorAll('.filter-test'))
                .filter(cb=>cb.checked)
                .map(cb=>cb.value);
        }

        async function main() {
            const results = await loadAll();
            let selected = getSelectedTests();
            updateKPIs(results, selected);
            renderTable(results, selected);
            const g = gatherForCharts(results, selected);
            createCharts(g.labels, g.avg, g.p95, g.reqs, g.statusCounts);
            document.querySelectorAll('.filter-test').forEach(cb=>cb.addEventListener('change', ()=>{
                selected = getSelectedTests();
                updateKPIs(results, selected);
                renderTable(results, selected);
                const g2 = gatherForCharts(results, selected);
                createCharts(g2.labels, g2.avg, g2.p95, g2.reqs, g2.statusCounts);
            }));

            // preencher conclusÃµes rÃ¡pidas
            document.getElementById('concl-1').innerText = `Painel carregado com ${Object.keys(results).length} testes. Revise filtros Ã  esquerda.`;
            
            // BotÃ£o tema
            document.getElementById('btn-theme').addEventListener('click', () => {
                document.body.classList.toggle('dark-theme');
                const isDark = document.body.classList.contains('dark-theme');
                document.getElementById('btn-theme').textContent = isDark ? 'â˜€ï¸ Tema Claro' : 'ðŸŒ™ Tema Escuro';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
            
            // Restaurar tema salvo
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('btn-theme').textContent = 'â˜€ï¸ Tema Claro';
            }
            
            // BotÃ£o export CSV
            document.getElementById('btn-export').addEventListener('click', () => {
                const selected = getSelectedTests();
                let csv = 'Teste,LatÃªncia MÃ©dia (ms),LatÃªncia p(95) (ms),Taxa de Falha (%),Total RequisiÃ§Ãµes\n';
                selected.forEach(k => {
                    const r = results[k];
                    csv += `${k.charAt(0).toUpperCase()+k.slice(1)},${r.avg.toFixed(2)},${r.p95.toFixed(2)},${r.fail.toFixed(2)},${r.reqs}\n`;
                });
                const blob = new Blob([csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'resultados_k6.csv';
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        // Inicializa
        main();
    </script>
</body>
</html>
